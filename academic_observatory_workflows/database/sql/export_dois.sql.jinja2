{#
Copyright 2020 Curtin University.
Authors: Richard Hosking
#}

SELECT 
  doi,
  mag.PaperId as mag_paperId,
  crossref.title as title,
  IF(crossref.abstract IS NOT NULL, crossref.abstract, mag.abstract) as abstract,
  DATE(crossref.published_year, 12, 31) AS published_year,
  unpaywall.output_type,
  crossref.publisher,
  unpaywall.journal_name as journal,
  mag.CitationCount as citation_count,

  unpaywall.is_oa,
  unpaywall.gold,
  unpaywall.green,
  unpaywall.bronze,
  unpaywall.hybrid,
  unpaywall.green_only,
  unpaywall.url_for_landing_page,

  ARRAY(SELECT DisplayName FROM UNNEST(mag.fields.level_0)) as level_0,
  ARRAY(SELECT DisplayName FROM UNNEST(mag.fields.level_1)) as level_1,
  ARRAY(SELECT DisplayName FROM UNNEST(mag.fields.level_2)) as level_2,
  ARRAY(SELECT DisplayName FROM UNNEST(mag.fields.level_3)) as level_3,

  ARRAY(SELECT AS STRUCT identifier, name, country, country_code, country_code_2 FROM UNNEST( affiliations.institutions ) WHERE identifier IS NOT NULL) as institutions,
  ARRAY(SELECT AS STRUCT identifier, name FROM UNNEST( affiliations.countries ) WHERE identifier IS NOT NULL) as countries,
  ARRAY(SELECT AS STRUCT identifier, name FROM UNNEST( affiliations.regions ) WHERE identifier IS NOT NULL) as regions,
  ARRAY(SELECT AS STRUCT identifier, name FROM UNNEST( affiliations.groupings ) WHERE identifier IS NOT NULL) as groupings,
  ARRAY(SELECT AS STRUCT identifier, name FROM UNNEST( affiliations.funders ) WHERE identifier IS NOT NULL) as funders,
  ARRAY(SELECT AS STRUCT identifier, name FROM UNNEST( affiliations.authors ) WHERE identifier IS NOT NULL) as authors,
FROM
  `{{ project_id }}.{{ dataset_id }}.{{ table_name }}`
WHERE crossref.published_year > 2000