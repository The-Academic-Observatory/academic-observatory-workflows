{#
  Copyright 2020 Curtin University.
  Authors: James Diprose, Richard Hosking

  The purpose of this script it to export the access_types section from any of the aggregration tables (country, institution, group, etc)
  Primarily, the goal is to create what is a nested array, and turn that into a flat table that can be exported into Elasticsearch for use with Kibana
#}
SELECT
  id                                                AS {{ aggregate }}_id,
  name                                              AS {{ aggregate }}_name,
  country                                           AS {{ aggregate }}_country,
  country_code                                      AS {{ aggregate }}_country_code,
  region                                            AS {{ aggregate }}_region,
  subregion                                         AS {{ aggregate }}_subregion,
  coordinates                                       AS {{ aggregate }}_coordinates,
  DATE(time_period, 12, 31)                         AS published_year,
  access_type.access_type                           AS access_types_access_type,
  access_type.status                                AS access_types_status,
  access_type.label                                 AS access_types_label,
  access_type.total_outputs                         AS access_types_total_outputs,
  access_type.outputs_with_citations                AS access_types_outputs_with_citations,
  access_type.outputs_without_citations             AS access_types_outputs_without_citations,
  access_type.citations.openalex.total_citations    AS access_types_total_citations,
  access_type.citations.openalex.percentiles.median AS access_types_median_citations_per_output
FROM `{{ project_id }}.{{ dataset_id }}.{{ table_id }}{{ release_date.strftime('%Y%m%d') }}`,
UNNEST( access_types.breakdown ) AS access_type
ORDER BY id, published_year ASC
