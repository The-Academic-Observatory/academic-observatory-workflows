{#
  # Copyright 2020 Curtin University
  #
  # Licensed under the Apache License, Version 2.0 (the "License");
  # you may not use this file except in compliance with the License.
  # You may obtain a copy of the License at
  #
  #   http://www.apache.org/licenses/LICENSE-2.0
  #
  # Unless required by applicable law or agreed to in writing, software
  # distributed under the License is distributed on an "AS IS" BASIS,
  # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  # See the License for the specific language governing permissions and
  # limitations under the License.

  # Author: Richard Hosking, James Diprose
#}
SELECT
  doi,
  ARRAY(
    SELECT AS STRUCT
      source     AS source,
      SUM(count) AS count
    FROM UNNEST(months)
    GROUP BY source
  ) AS events,
  months,
  ARRAY(
    SELECT AS STRUCT
      CAST(SPLIT(month, "-")[SAFE_OFFSET(0)] AS int64) AS year,
      source                                           AS source,
      SUM(count)                                       AS count
    FROM UNNEST(months)
    GROUP BY year, source
  ) AS years
FROM (
  SELECT
    doi                                     AS doi,
    ARRAY_AGG(STRUCT(month, source, count)) AS months
  FROM (
    SELECT
      (UPPER(TRIM(SUBSTR(obj_id, 17))))           AS doi,
      safe.FORMAT_TIMESTAMP('%Y-%m', occurred_at) AS month,
      source_id                                   AS source,
      COUNT(id)                                   AS count
    FROM `{{ crossref_events.project_id }}.{{ crossref_events.dataset_id }}.{{ crossref_events.table_id }}`
    WHERE safe.FORMAT_TIMESTAMP('%Y-%m', occurred_at) IS NOT NULL
    GROUP BY doi, source_id, month
  )
  GROUP BY doi
)
