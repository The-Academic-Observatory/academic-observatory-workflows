{#
  Copyright 2020 Curtin University.
  Authors: Richard Hosking

  The purpose of this script it to export the disciplines section from any of the aggregration tables (country, institution, group, etc)
  Primarily, the goal is to create what is a nested array, and turn that into a flat table that can be exported into Elasticsearch for use with Kibana
#}
SELECT
  id                                                        AS {{ aggregate }}_id,
  name                                                      AS {{ aggregate }}_name,
  country                                                   AS {{ aggregate }}_country,
  country_code                                              AS {{ aggregate }}_country_code,
  region                                                    AS {{ aggregate }}_region,
  subregion                                                 AS {{ aggregate }}_subregion,
  coordinates                                               AS {{ aggregate }}_coordinates,
  DATE(time_period, 12, 31)                                 AS published_year,
  discipline.field                                          AS disciplines_field,
  discipline.total_outputs                                  AS disciplines_total_outputs,
  discipline.sum_of_scores                                  AS disciplines_sum_of_scores,
  discipline.num_oa_outputs                                 AS disciplines_num_oa_outputs,
  discipline.num_green_outputs                              AS disciplines_num_green_outputs,
  discipline.num_gold_outputs                               AS disciplines_num_gold_outputs,
  discipline.num_gold_just_doaj_outputs                     AS disciplines_num_gold_just_doaj_outputs,
  discipline.num_hybrid_outputs                             AS disciplines_num_hybrid_outputs,
  discipline.num_bronze_outputs                             AS disciplines_num_bronze_outputs,
  discipline.num_green_only_outputs                         AS disciplines_num_green_only_outputs,
  ROUND(SAFE_DIVIDE((discipline.num_oa_outputs   ) * 100, discipline.total_outputs), 2) AS disciplines_percent_oa,
  ROUND(SAFE_DIVIDE((discipline.num_green_outputs) * 100, discipline.total_outputs), 2) AS disciplines_percent_green,
  ROUND(SAFE_DIVIDE((discipline.num_gold_outputs ) * 100, discipline.total_outputs), 2) AS disciplines_percent_gold,
  discipline.citations.openalex.total_citations             AS disciplines_total_citations,
  discipline.citations.openalex.percentiles.median          AS disciplines_median_citations_per_output,
  discipline.funding.total_funded_outputs                   AS disciplines_total_funded_outputs,
  discipline.funding.num_international_outputs              AS disciplines_num_international_funded_outputs,
  discipline.funding.num_domestic_outputs                   AS disciplines_num_domestic_funded_outputs,
  discipline.funding.num_international_and_domestic_outputs AS disciplines_num_international_and_domestic_funded_outputs,
  discipline.funding.num_government_outputs                 AS disciplines_num_government_funded_outputs,
  discipline.funding.num_private_outputs                    AS disciplines_num_private_funded_outputs,
  discipline.funding.num_government_and_private_outputs     AS disciplines_num_government_and_private_funded_outputs
FROM `{{ project_id }}.{{ dataset_id }}.{{ table_id }}{{ release_date.strftime('%Y%m%d') }}`,
UNNEST(disciplines.level0) AS discipline
ORDER BY id, published_year ASC
