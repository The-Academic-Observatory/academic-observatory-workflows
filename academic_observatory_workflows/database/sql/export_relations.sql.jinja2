{#
  Copyright 2020 Curtin University.
  Authors: Richard Hosking

  The purpose of this script it to export a range of sections from any of the aggregration tables (country, institution, group, etc)
  The sections this applies to are: institution, memember, country, funders, publishers and journals
  Primarily, the goal is to create what is a nested array, and turn that into a flat table that can be exported into Elasticsearch for use with Kibana
#}
SELECT
  entity.id                           AS {{ aggregate }}_id,
  entity.name                         AS {{ aggregate }}_name,
  entity.country                      AS {{ aggregate }}_country,
  entity.country_code                 AS {{ aggregate }}_country_code,
  entity.region                       AS {{ aggregate }}_region,
  entity.subregion                    AS {{ aggregate }}_subregion,
  entity.coordinates                  AS {{ aggregate }}_coordinates,
  DATE(entity.time_period, 12, 31)    AS published_year,
  relation.id                         AS {{ facet }}_id,
  relation.name                       AS {{ facet }}_name,
  relation.country                    AS {{ facet }}_country,
  relation.country_code               AS {{ facet }}_country_code,
  relation.region                     AS {{ facet }}_region,
  relation.subregion                  AS {{ facet }}_subregion,
  relation.coordinates                AS {{ facet }}_coordinates,
  relation.total_outputs              AS {{ facet }}_total_outputs,
  relation.num_oa_outputs             AS {{ facet }}_num_oa_outputs,
  relation.num_green_outputs          AS {{ facet }}_num_green_outputs,
  relation.num_gold_outputs           AS {{ facet }}_num_gold_outputs,
  relation.num_gold_just_doaj_outputs AS {{ facet }}_num_gold_just_doaj_outputs,
  relation.num_hybrid_outputs         AS {{ facet }}_num_hybrid_outputs,
  relation.num_bronze_outputs         AS {{ facet }}_num_bronze_outputs,
  relation.num_green_only_outputs     AS {{ facet }}_num_green_only_outputs,
  relation.citations.openalex         AS {{ facet }}_total_citations,
  ROUND(SAFE_DIVIDE((relation.num_oa_outputs   ) * 100, relation.total_outputs), 2) AS {{ facet }}_percent_oa,
  ROUND(SAFE_DIVIDE((relation.num_green_outputs) * 100, relation.total_outputs), 2) AS {{ facet }}_percent_green,
  ROUND(SAFE_DIVIDE((relation.num_gold_outputs ) * 100, relation.total_outputs), 2) AS {{ facet }}_percent_gold,
  relation.percentage_of_all_outputs  AS {{ facet }}_percent_of_all_outputs,
  relation.percentage_of_all_oa       AS {{ facet }}_percent_of_all_oa
FROM `{{ project_id }}.{{ dataset_id }}.{{ table_id }}{{ release_date.strftime('%Y%m%d') }}` AS entity,
UNNEST({{ facet }}) AS relation
ORDER BY entity.id, published_year ASC
